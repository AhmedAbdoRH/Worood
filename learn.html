<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراجعة الكلمات (مع تسجيل الدخول)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark-primary: #0a0f1a;
            --bg-dark-secondary: #151c2a;
            --bg-dark-tertiary: #2a3447;
            --bg-dark-quaternary: #3e4859;
            --border-dark: #2a3447;
            --border-dark-focus: #60a5fa;
            --text-light-primary: #e5e7eb;
            --text-light-secondary: #d1d5db;
            --text-light-tertiary: #9ca3af;
            --text-placeholder: #6b7280;
            --primary-color: #b91c1c; /* Red */
            --primary-color-hover: #9b1717;
            --secondary-color: #3e4859; /* Gray */
            --secondary-color-hover: #2a3447;
            --success-color: #137c3a; /* Green */
            --success-color-hover: #106632;
            --danger-color: #b91c1c; /* Red */
            --danger-color-hover: #9b1717;
            --danger-outline-color: #e55e5e;
            --danger-outline-hover-bg: rgba(185, 28, 28, 0.1);
            --font-family-base: 'Cairo', sans-serif;
            --border-radius-lg: 0.75rem;
            --border-radius-md: 0.5rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --blur: 8px;
            --white0: hsla(0, 0%, 100%, 0);
            --white50: hsla(0, 0%, 100%, 0.05);
            --white100: hsla(0, 0%, 50%, 0.3);
            --white200: hsla(0, 0%, 50%, 0.4);
            --white300: hsla(0, 0%, 80%, 0.5);
            --white: hsl(0, 0%, 100%);
            font-size: clamp(0.95rem, 0.75rem + 0.6vw, 1.85rem);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; border: 0; }
        html, body { background-color: var(--bg-dark-primary); color: var(--text-light-primary); font-family: var(--font-family-base); line-height: 1.5; }
        body { min-height: 100vh; display: grid; place-items: center; padding: 0.5rem; background: linear-gradient(90deg, var(--bg-dark-secondary), var(--bg-dark-primary)); }
        .hidden { display: none !important; }
        .container { width: 100%; max-width: 36rem; margin-left: auto; margin-right: auto; }
        @media (min-width: 768px) { .container { max-width: 42rem; } }
        .page { transition: opacity 0.3s ease-in-out; }
        .heading-1 { font-size: 1.875rem; font-weight: 700; text-align: center; color: var(--border-dark-focus); margin-bottom: 1rem; }
        @media (min-width: 768px) { .heading-1 { font-size: 2.25rem; margin-bottom: 1.5rem; } }
        .heading-2 { font-size: 1.125rem; font-weight: 600; color: var(--text-light-primary); margin-bottom: 0.75rem; }
        @media (min-width: 768px) { .heading-2 { font-size: 1.25rem; } }
        .card { padding: 1.25rem; border-radius: var(--border-radius-lg); transition: all 0.3s ease-in-out; text-align: center; color: var(--text-light-primary); background-color: transparent; border: none; box-shadow: none; position: relative; backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur)); background-image: linear-gradient(90deg, var(--white200), var(--white50)); overflow: hidden; }
        [dir="rtl"] .card { background-image: linear-gradient(-90deg, var(--white200), var(--white50)); }
        .card:before, .card:after { content: ""; position: absolute; inset: 0; border-radius: inherit; z-index: -1; }
        .card:before { border: 1px solid var(--white); mask-image: linear-gradient(135deg, var(--white), var(--white0) 50%); -webkit-mask-image: linear-gradient(135deg, var(--white), var(--white0) 50%); }
        [dir="rtl"] .card:before { mask-image: linear-gradient(-135deg, var(--white), var(--white0) 50%); -webkit-mask-image: linear-gradient(-135deg, var(--white), var(--white0) 50%); }
        .card:after { border: 1px solid var(--primary-color); mask-image: linear-gradient(135deg, var(--white0) 50%, var(--white)); -webkit-mask-image: linear-gradient(135deg, var(--white0) 50%, var(--white)); }
        [dir="rtl"] .card:after { mask-image: linear-gradient(-135deg, var(--white0) 50%, var(--white)); -webkit-mask-image: linear-gradient(-135deg, var(--white0) 50%, var(--white)); }
        .card--add { text-align: right; margin-bottom: 1rem; }
        .card--word-display { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 2rem; padding: 1.5rem; }
        .card--auth { max-width: 28rem; margin: 2rem auto; text-align: right; }
        @media (min-width: 768px) { .card { padding: 1.5rem; } .card--word-display { padding: 1.5rem; } }
        .word-display-large { font-size: clamp(2rem, 13vw, 6.5rem); font-weight: 700; color: white; text-align: center; word-break: break-word; overflow-wrap: break-word; line-height: 1.1; width: 100%; padding: 0.25rem 0; margin-bottom: 0.25rem; min-height: 1.2em; }
        #wordDisplayCard #translationDisplay { font-size: 1rem; color: var(--text-light-secondary); margin-top: 0; margin-bottom: 0; font-weight: 400; text-align: center; word-break: break-word; width: 100%; padding-bottom: 0.5rem; min-height: 1.2em; }
        @media (min-width: 768px) { #wordDisplayCard #translationDisplay { font-size: 1.125rem; } }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); font-weight: 600; color: white; transition: all 0.2s ease-in-out; box-shadow: var(--shadow-md); border: none; cursor: pointer; font-size: 0.75rem; line-height: 1.25; text-decoration: none; }
        @media (min-width: 768px) { .btn { font-size: 0.875rem; gap: 0.5rem; } }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:focus { outline: none; box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--border-dark-focus); }
        .btn--sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; gap: 0.25rem; border-radius: 0.375rem; }
        .btn--primary { background-color: var(--primary-color); }
        .btn--primary:hover:not(:disabled) { background-color: var(--primary-color-hover); }
        .btn--secondary { background-color: var(--secondary-color); }
        .btn--secondary:hover:not(:disabled) { background-color: var(--secondary-color-hover); }
        .btn--action { padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 700; border-radius: var(--border-radius-md); gap: 0.25rem; }
        .btn--action:hover:not(:disabled) { transform: scale(1.05); }
        .btn--success { background-color: var(--success-color); }
        .btn--success:hover:not(:disabled) { background-color: var(--success-color-hover); }
        .btn--success:focus { box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--success-color); }
        .btn--danger { background-color: var(--danger-color); }
        .btn--danger:hover:not(:disabled) { background-color: var(--danger-color-hover); }
        .btn--danger:focus { box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--danger-color); }
        .btn--full-width { width: 100%; }
        .btn--fixed { position: fixed; bottom: 1rem; left: 1rem; z-index: 1000; padding: 0.5rem 1rem; background-color: var(--secondary-color); }
        .btn--fixed:hover:not(:disabled) { background-color: var(--secondary-color-hover); }
        .label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-light-secondary); margin-bottom: 0.25rem; }
        .input-field, .textarea-field { margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 1rem; background-color: var(--bg-dark-primary); border: 1px solid var(--border-dark); border-radius: var(--border-radius-md); font-size: 0.875rem; box-shadow: var(--shadow-md); color: var(--text-light-primary); }
        .textarea-field { min-height: 80px; line-height: 1.5; }
        .input-field::placeholder, .textarea-field::placeholder { color: var(--text-placeholder); }
        .input-field:focus, .textarea-field:focus { outline: none; border-color: var(--border-dark-focus); box-shadow: 0 0 0 1px var(--border-dark-focus); }
        .textarea-readonly { background-color: var(--bg-dark-tertiary); border-color: var(--border-dark); color: var(--text-light-secondary); cursor: default; }
        .textarea-readonly:focus { border-color: var(--border-dark); box-shadow: none; }
        .input-container { margin-bottom: 0.25rem; }
        .message { font-size: 0.75rem; margin-top: 0.5rem; text-align: center; min-height: 1rem; }
        .message--small { margin-top: 0.25rem; min-height: 0.75rem; }
        .message--success { color: var(--success-color); }
        .message--error { color: var(--danger-color); }
        .message--info { color: var(--text-light-secondary); }
        .message--warning { color: #facc15; /* Yellow */ }
        .message--default { color: var(--text-light-tertiary); }
        .button-group { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .margin-top-1 { margin-top: 0.25rem; } .margin-top-2 { margin-top: 0.5rem; } .margin-top-3 { margin-top: 0.75rem; } .margin-top-4 { margin-top: 1rem; } .margin-top-5 { margin-top: 1.25rem; } .margin-top-7 { margin-top: 1.75rem; }
        .margin-bottom-3 { margin-bottom: 0.75rem; } .margin-bottom-4 { margin-bottom: 1rem; } .margin-bottom-6 { margin-bottom: 1.5rem; }
        .padding-top-3 { padding-top: 0.75rem; } .padding-top-4 { padding-top: 1rem; }
        .border-top { border-top: 1px solid var(--border-dark); }
        .loader { display: inline-block; animation: spin 1s linear infinite; border-radius: 50%; width: 1rem; height: 1rem; border-top: 2px solid white; border-bottom: 2px solid white; border-left: 2px solid transparent; border-right: 2px solid transparent; margin-left: 0.5rem; }
        .btn .loader { margin-left: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .small-text { font-size: 0.625rem; color: var(--text-light-tertiary); }
        @media (min-width: 768px) { .small-text { font-size: 0.75rem; } }
        .icon { width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; }
        .icon--sm { width: 0.75rem; height: 0.75rem; }
        .icon--lg { width: 1.25rem; height: 1.25rem; }
        #authStatus { text-align: left; padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-light-secondary); }
        #authStatus span { font-weight: 600; color: var(--text-light-primary); }
        #logoutBtn { margin-right: auto; /* Pushes button to the left in RTL */ }
        #mainAppContainer { transition: opacity 0.3s ease-in-out; }
        .link-like {
            background: none;
            border: none;
            color: var(--border-dark-focus);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
            margin-top: 0.5rem;
        }
        .link-like:hover {
            color: #3b82f6; /* Lighter blue on hover */
        }
        /* Style for global status message */
        #globalStatus {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark-tertiary);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-md);
            z-index: 2000;
            display: none; /* Initially hidden */
            box-shadow: var(--shadow-lg);
            text-align: center;
            color: var(--text-light-primary); /* Default color */
        }
        #globalStatus.message-error { background-color: var(--danger-color); color: white; }
        #globalStatus.message-success { background-color: var(--success-color); color: white; }
        #globalStatus.message-warning { background-color: #d97706; color: white; } /* Amber for warning */
        #globalStatus.message-info { background-color: var(--bg-dark-tertiary); color: var(--text-light-primary); }
    </style>
</head>
<body>
    <div class="container">

        <div id="authSection" class="hidden">
            <div class="card card--auth">
                <div id="loginForm">
                    <h2 class="heading-2">تسجيل الدخول</h2>
                    <div class="input-container margin-bottom-3">
                        <label for="loginEmail" class="label">البريد الإلكتروني:</label>
                        <input type="email" id="loginEmail" class="input-field" placeholder="email@example.com" required>
                    </div>
                    <div class="input-container margin-bottom-4">
                        <label for="loginPassword" class="label">كلمة المرور:</label>
                        <input type="password" id="loginPassword" class="input-field" required>
                    </div>
                    <button id="loginBtn" class="btn btn--primary btn--full-width">تسجيل الدخول</button>
                    <p id="loginMessage" class="message message--default"></p>
                    <button id="showSignupBtn" class="link-like">ليس لديك حساب؟ إنشاء حساب جديد</button>
                </div>

                <div id="signupForm" class="hidden">
                    <h2 class="heading-2">إنشاء حساب جديد</h2>
                    <div class="input-container margin-bottom-3">
                        <label for="signupEmail" class="label">البريد الإلكتروني:</label>
                        <input type="email" id="signupEmail" class="input-field" placeholder="email@example.com" required>
                    </div>
                    <div class="input-container margin-bottom-4">
                        <label for="signupPassword" class="label">كلمة المرور:</label>
                        <input type="password" id="signupPassword" class="input-field" required placeholder="6 أحرف على الأقل">
                    </div>
                    <button id="signupBtn" class="btn btn--primary btn--full-width">إنشاء حساب</button>
                    <p id="signupMessage" class="message message--default"></p>
                    <button id="showLoginBtn" class="link-like">لديك حساب بالفعل؟ تسجيل الدخول</button>
                </div>
            </div>
        </div>

        <div id="mainAppContainer" class="hidden">
            <div id="authStatus" class="margin-bottom-4">
                 مرحباً <span id="userEmailDisplay"></span>
                 <button id="logoutBtn" class="btn btn--secondary btn--sm" style="float: left;">تسجيل الخروج</button>
            </div>

            <h1 class="heading-1">
                 أداة مراجعة الكلمات
            </h1>
            <div id="pageAddWords" class="page">
                 <div class="card card--add">
                     <h2 class="heading-2">1. إضافة كلمات جديدة</h2>
                     <div class="input-container">
                         <label for="bulkInput" class="label">ألصق النص (كل سطر: كلمة فاصل ترجمة):</label>
                         <textarea id="bulkInput" class="textarea-field" rows="5" placeholder="مثال:
Hello : مرحباً
Book = كتاب
World	عالم"></textarea>
                     </div>
                      <p id="pasteMessage" class="message message--small message--default"></p>
                     <button id="addBulkBtn" class="btn btn--primary btn--full-width margin-top-3">
                         <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--lg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                         <span id="addBtnText">إضافة الكلمات</span>
                         <span id="addBtnLoader" class="loader hidden"></span>
                     </button>
                     <p id="addMessage" class="message message--default"></p>
                     <div class="paste-button-container margin-top-4">
                         <button id="pasteBtn" title="لصق من الحافظة" class="btn btn--secondary btn--sm btn--full-width">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon"><path fill-rule="evenodd" d="M15.99 4.01h-1.48a3.5 3.5 0 00-6.98 0H6.01a2 2 0 00-2 2v10a2 2 0 002 2h9.98a2 2 0 002-2V6.01a2 2 0 00-2-2zm-8.98 14V6.01h1.48v-.03a2 2 0 114 0v.03h1.48l.01 11.99H7.01zm4.49-11.03a.5.5 0 00-1 0v.03h1v-.03z" clip-rule="evenodd" /></svg>
                             <span>لصق من الحافظة</span>
                         </button>
                     </div>
                     <div class="margin-top-5 border-top padding-top-4">
                          <button id="gotoReviewBtn_FromAdd" class="btn btn--secondary btn--full-width margin-bottom-6">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon icon--lg"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.03a.75.75 0 000-1.5H4.333a.75.75 0 00-.75.75v3.167a.75.75 0 001.5 0v-2.03l.31.312a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm1.23-3.723a.75.75 0 00-1.449.389A7 7 0 003.028 10.07l-.31.311H4.75a.75.75 0 000-1.5H1.583a.75.75 0 00-.75.75v3.167a.75.75 0 001.5 0v-2.03l.312-.31a5.5 5.5 0 019.201-2.466.75.75 0 001.449-.39z" clip-rule="evenodd" /></svg>
                              بدء المراجعة مباشرة
                          </button>
                     </div>
                 </div>
            </div>
            <div id="pageReview" class="page hidden">
                <div id="wordDisplayCard" class="card--word-display hidden">
                    <div id="wordDisplayLarge" class="word-display-large"></div>
                    <div id="translationDisplay" class="translation-display hidden"></div>
                </div>
                <div class="card">
                    <div id="flashcardContainer" class="hidden">
                        <p id="progressDisplay" class="small-text margin-bottom-3"></p>
                        <button id="showTranslationBtn" class="btn btn--secondary btn--sm margin-top-2 margin-bottom-3">إظهار/إخفاء الترجمة</button>
                        <div id="difficultyButtonsContainer" class="button-group">
                             <button id="markEasyBtn" class="btn btn--action btn--success"> <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"> <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /> </svg>
                                 أعرفها (سهلة)
                             </button>
                             <button id="markHardBtn" class="btn btn--action btn--danger"> <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                                 لا أعرفها (صعبة)
                             </button>
                        </div>
                    </div>
                     <p id="sessionMessage" class="message message--info"></p>
                     <div id="hardWordsListContainer" class="margin-top-4 border-top padding-top-3 hidden">
                         <h3 class="heading-2" style="font-size: 0.875rem; margin-bottom: 0.25rem;">الكلمات المتبقية للمراجعة:</h3>
                         <textarea id="hardWordsOutput" rows="4" readonly class="textarea-field textarea-readonly" style="font-size: 0.75rem;"></textarea>
                         <button id="copyHardWordsBtn" class="btn btn--secondary btn--sm margin-top-2">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon icon--sm"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z" /></svg>
                             نسخ القائمة
                         </button>
                         <p id="copyMessage" class="message message--small message--default"></p>
                     </div>
                     <button id="gotoAddBtn_FromReview" class="btn btn--secondary btn--full-width margin-top-7 btn--sm">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                         العودة لإضافة كلمات
                     </button>
                </div>
            </div>
            <button id="gotoHardWordsBtn" class="btn btn--fixed btn--sm hidden"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z" /></svg>
                الكلمات الصعبة
            </button>
        </div> <div id="globalStatus" class="message message-info">
            جاري التحميل...
        </div>

    </div> <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import {
            getFirestore, collection, addDoc, getDocs, updateDoc, query, where, doc, deleteDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

        // --- Firebase Configuration (User Provided) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAunLxvASN6Cbsa_Nc6l78_5lMhe5fP2Qg",
            authDomain: "momtn-ecab7.firebaseapp.com",
            projectId: "momtn-ecab7",
            storageBucket: "momtn-ecab7.appspot.com",
            messagingSenderId: "98544311111",
            appId: "1:98544311111:web:0158668f45ae34818fca62",
            measurementId: "G-W164SZBMDP"
         };

        // --- Firebase Initialization ---
        let app;
        let db;
        let auth;
        let firestoreInitialized = false;
        let authInitialized = false;
        let currentUserId = null; // To store the current user's ID

        // --- DOM Element References ---
        // It's good practice to get references early, but ensure the DOM is ready
        // We will get them inside DOMContentLoaded listener to be safe
        let authSection, loginForm, signupForm, loginEmailInput, loginPasswordInput, loginBtn, loginMessage, showSignupBtn, signupEmailInput, signupPasswordInput, signupBtn, signupMessage, showLoginBtn, authStatus, userEmailDisplay, logoutBtn, mainAppContainer, globalStatus, mainHeading, pageAddWords, pageReview, gotoAddBtn_FromReview, gotoReviewBtn_FromAdd, bulkInput, pasteBtn, pasteMessage, addBulkBtn, addBtnText, addBtnLoader, addMessage, wordDisplayCard, wordDisplayLarge, flashcardContainer, progressDisplay, translationDisplay, showTranslationBtn, difficultyButtonsContainer, markEasyBtn, markHardBtn, sessionMessage, hardWordsListContainer, hardWordsOutput, copyHardWordsBtn, copyMessage, gotoHardWordsBtn;

        // --- Firestore Constants ---
        const WORDS_COLLECTION = 'userWords'; // Collection name in Firestore

        // --- App State ---
        let currentSessionWords = [];
        let currentWordIndex = 0;


        // --- Utility Functions ---
        function showGlobalStatus(message, type = 'info', duration = 3000) {
            if (!globalStatus) {
                console.error("showGlobalStatus: globalStatus element not found.");
                return;
            }
            console.log(`[Status] ${type}: ${message}`); // Log status messages
            globalStatus.textContent = message;
            // Use className to easily set the type and base style
            globalStatus.className = `message message-${type}`;
            globalStatus.style.display = 'block'; // Make sure it's visible

            if (duration > 0) {
                setTimeout(() => {
                    // Hide only if the message is still the same one we set
                    if (globalStatus.textContent === message) {
                       globalStatus.style.display = 'none';
                    }
                }, duration);
            }
        }

        function hideGlobalStatus() {
            if (globalStatus) globalStatus.style.display = 'none';
        }

        function showPage(pageId) {
            console.log(`[UI] Showing page: ${pageId}`);
            // Hide all pages first
            if (pageAddWords) pageAddWords.classList.add('hidden');
            if (pageReview) pageReview.classList.add('hidden');

            const pageToShow = document.getElementById(pageId);
            if (pageToShow) {
                 pageToShow.classList.remove('hidden');
                 // Fade-in effect
                 pageToShow.style.opacity = '0';
                 setTimeout(() => { if(pageToShow) pageToShow.style.opacity = '1'; }, 50);
            } else {
                console.error(`[UI] showPage: Page with ID "${pageId}" not found.`);
            }

            // Adjust heading visibility based on the page
            if (mainHeading) {
                if (pageId === 'pageReview') {
                    const isReviewCardVisible = flashcardContainer && !flashcardContainer.classList.contains('hidden');
                    mainHeading.classList.toggle('hidden', isReviewCardVisible);
                     if (flashcardContainer && flashcardContainer.parentElement && isReviewCardVisible) {
                       flashcardContainer.parentElement.classList.remove('hidden');
                    }
                } else { // pageAddWords
                    mainHeading.classList.remove('hidden');
                    if(wordDisplayCard) wordDisplayCard.classList.add('hidden');
                }
            }
             if (translationDisplay) translationDisplay.classList.add('hidden');
        }

        function toggleButtonLoading(button, textElement, loaderElement, isLoading, loadingText = '') {
             if (!button || !textElement || !loaderElement) {
                 console.warn("[UI] toggleButtonLoading: Missing element reference.", { button, textElement, loaderElement });
                 return;
             }
             if (!textElement.dataset.originalText) {
                 textElement.dataset.originalText = textElement.textContent;
             }
             const originalText = textElement.dataset.originalText;
             button.disabled = isLoading;
             if (isLoading) {
                 loaderElement.classList.remove('hidden');
                 textElement.textContent = loadingText || originalText;
             } else {
                 loaderElement.classList.add('hidden');
                 textElement.textContent = originalText;
             }
        }

        function setTemporaryMessage(element, message, cssClassSuffix, isSmall = false, duration = 3500) {
            if (!element) {
                console.warn(`[UI] setTemporaryMessage: Target element not found for message: ${message}`);
                return;
            }
            console.log(`[Message] ${cssClassSuffix}: ${message}`); // Log user messages
            element.textContent = message;
            element.className = 'message'; // Reset base class
            element.classList.add(`message--${cssClassSuffix}`);
            element.classList.toggle('message--small', isSmall);

            setTimeout(() => {
                if (element.textContent === message) {
                    element.textContent = '';
                    element.className = 'message message--default';
                    element.classList.toggle('message--small', isSmall);
                }
            }, duration);
        }

        function setSessionMessage(message, cssClassSuffix = 'info') {
            if (!sessionMessage) return;
            console.log(`[Session Message] ${cssClassSuffix}: ${message}`);
            sessionMessage.textContent = message;
            sessionMessage.className = 'message'; // Reset base class
            sessionMessage.classList.add(`message--${cssClassSuffix}`);
        }

        // --- Firestore Functions (User-Specific) ---
        async function checkWordExists(word) {
            if (!firestoreInitialized || !currentUserId) {
                 console.error("[Firestore] checkWordExists: Firestore not ready or user not logged in.");
                 setTemporaryMessage(addMessage, 'خطأ: لا يمكن التحقق من الكلمة (مشكلة اتصال أو تسجيل دخول).', 'error', false);
                 return true; // Assume exists on error
            }
            console.log(`[Firestore] Checking if word "${word}" exists for user ${currentUserId}`);
            const q = query(collection(db, WORDS_COLLECTION),
                            where("word", "==", word),
                            where("userId", "==", currentUserId));
            try {
                const querySnapshot = await getDocs(q);
                const exists = !querySnapshot.empty;
                console.log(`[Firestore] Word "${word}" exists for user ${currentUserId}: ${exists}`);
                return exists;
            } catch (error) {
                console.error("[Firestore] Error checking word existence:", error);
                setTemporaryMessage(addMessage, `خطأ عند التحقق من وجود كلمة "${word}".`, 'error', false);
                return true; // Assume exists on error
            }
        }

        async function addWordFirestore(wordObject) {
            if (!firestoreInitialized || !currentUserId) {
                console.error("[Firestore] addWordFirestore: Firestore not ready or user not logged in.");
                setTemporaryMessage(addMessage, 'خطأ: لا يمكن إضافة الكلمة (مشكلة اتصال أو تسجيل دخول).', 'error', false);
                return null;
            }
            console.log(`[Firestore] Attempting to add word "${wordObject.word}" for user ${currentUserId}`);
            try {
                 const docPayload = {
                    ...wordObject,
                    userId: currentUserId,
                    status: 'hard',
                    createdAt: serverTimestamp()
                 };
                 console.log("[Firestore] Payload:", docPayload);
                 const docRef = await addDoc(collection(db, WORDS_COLLECTION), docPayload);
                 console.log("[Firestore] Word added successfully with ID:", docRef.id);
                return docRef;
            } catch (error) {
                 console.error("[Firestore] Error adding word:", error);
                 let userMessage = `خطأ عند إضافة كلمة "${wordObject.word}" لقاعدة البيانات.`;
                 if (error.code === 'permission-denied') {
                     userMessage = `خطأ صلاحية Firestore: ليس لديك الإذن لإضافة كلمات. تأكد من تحديث قواعد الأمان للسماح بالكتابة للمستخدمين المسجلين (مثل ${currentUserId}). راجع الكونسول (F12) لرسالة الخطأ الكاملة.`;
                     console.error("PERMISSION DENIED: Check Firestore rules. Rule evaluated:", error.customData?.rule);
                 } else if (error.message.includes("Function addDoc() called with invalid data")) {
                     userMessage = `خطأ بيانات: حاول Firestore إضافة بيانات غير صالحة. قد تكون هناك مشكلة في كائن الكلمة.`;
                     console.error("Invalid data passed to addDoc:", wordObject);
                 }
                 setTemporaryMessage(addMessage, userMessage, 'error', false, 7000); // Show longer for permission errors
                 return null;
            }
        }

        async function getHardWordsFirestore() {
            if (!firestoreInitialized || !currentUserId) {
                console.error("[Firestore] getHardWordsFirestore: Firestore not ready or user not logged in.");
                setSessionMessage('خطأ: لا يمكن جلب الكلمات (مشكلة اتصال أو تسجيل دخول).', 'error');
                return null;
            }
            console.log(`[Firestore] Fetching 'hard' words for user ${currentUserId}`);
            const q = query(collection(db, WORDS_COLLECTION),
                            where("userId", "==", currentUserId),
                            where("status", "==", "hard"));
            try {
                const querySnapshot = await getDocs(q);
                const words = [];
                querySnapshot.forEach((doc) => {
                    words.push({ id: doc.id, ...doc.data() });
                });
                console.log(`[Firestore] Fetched ${words.length} hard words for user ${currentUserId}`);
                return words.sort(() => Math.random() - 0.5);
            } catch (error) {
                 console.error("[Firestore] Error fetching hard words:", error);
                 if (error.code === 'permission-denied') {
                     setSessionMessage(`خطأ صلاحية Firestore: ليس لديك الإذن لقراءة الكلمات. تأكد من تحديث قواعد الأمان للسماح بالقراءة للمستخدمين المسجلين (مثل ${currentUserId}). راجع الكونسول (F12) لرسالة الخطأ الكاملة.`, 'error');
                      console.error("PERMISSION DENIED: Check Firestore rules. Rule evaluated:", error.customData?.rule);
                 } else {
                     setSessionMessage(`خطأ عند جلب الكلمات: ${error.message}`, 'error');
                 }
                return null;
            }
        }

        async function updateWordStatusFirestore(docId, newStatus) {
             if (!firestoreInitialized || !currentUserId) {
                 console.error("[Firestore] updateWordStatusFirestore: Firestore not ready or user not logged in.");
                 setSessionMessage('خطأ: لا يمكن تحديث حالة الكلمة (مشكلة اتصال أو تسجيل دخول).', 'error');
                 throw new Error("Firestore not ready or user not logged in.");
             }
             console.log(`[Firestore] Updating word ${docId} to status "${newStatus}" for user ${currentUserId}`);
             const wordDocRef = doc(db, WORDS_COLLECTION, docId);
             try {
                await updateDoc(wordDocRef, { status: newStatus });
                console.log(`[Firestore] Word ${docId} status updated successfully.`);
             } catch (error) {
                console.error(`[Firestore] Error updating word ${docId} status:`, error);
                let userMessage = `خطأ في تحديث حالة الكلمة (ID: ${docId}).`;
                 if (error.code === 'permission-denied') {
                     userMessage = `خطأ صلاحية Firestore: ليس لديك الإذن لتحديث هذه الكلمة. تأكد من أن قواعد الأمان تسمح للمستخدم (${currentUserId}) بتحديث مستنداته.`;
                      console.error("PERMISSION DENIED: Check Firestore rules. Rule evaluated:", error.customData?.rule);
                 }
                setSessionMessage(userMessage, 'error');
                throw error; // Re-throw
             }
        }

        // --- Authentication Functions ---
        function handleLogin(event) {
            event.preventDefault();
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            loginMessage.textContent = '';
            console.log(`[Auth] Attempting login for: ${email}`);

            if (!email || !password) {
                setTemporaryMessage(loginMessage, 'الرجاء إدخال البريد الإلكتروني وكلمة المرور.', 'warning', false);
                return;
            }
            if (!authInitialized) {
                 console.error("[Auth] Login attempt failed: Auth service not initialized.");
                 setTemporaryMessage(loginMessage, 'خدمة المصادقة غير جاهزة. حاول لاحقاً.', 'error', false);
                 return;
            }

            showGlobalStatus('جاري تسجيل الدخول...', 'info', 0);

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Success: onAuthStateChanged will handle UI
                    console.log("[Auth] Login successful for:", userCredential.user.email, "UID:", userCredential.user.uid);
                    // hideGlobalStatus() will be called by onAuthStateChanged handler
                })
                .catch((error) => {
                    hideGlobalStatus();
                    console.error("[Auth] Login Error:", error.code, error.message);
                    let message = 'فشل تسجيل الدخول. ';
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            message += 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                            break;
                        case 'auth/invalid-email':
                            message += 'صيغة البريد الإلكتروني غير صالحة.';
                            break;
                        case 'auth/user-disabled':
                            message += 'تم تعطيل هذا الحساب.';
                            break;
                        case 'auth/network-request-failed':
                             message += 'فشل الاتصال بالشبكة. تحقق من اتصالك بالإنترنت.';
                             break;
                        case 'auth/too-many-requests':
                            message += 'تم حظر محاولات تسجيل الدخول مؤقتًا بسبب كثرة المحاولات الفاشلة. حاول مرة أخرى لاحقًا.';
                             break;
                        default:
                            message += `حدث خطأ غير متوقع (${error.code}).`;
                    }
                    setTemporaryMessage(loginMessage, message, 'error', false, 5000);
                });
        }

        function handleSignup(event) {
            event.preventDefault();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            signupMessage.textContent = '';
            console.log(`[Auth] Attempting signup for: ${email}`);

            if (!email || !password) {
                setTemporaryMessage(signupMessage, 'الرجاء إدخال البريد الإلكتروني وكلمة المرور.', 'warning', false);
                return;
            }
            if (password.length < 6) {
                setTemporaryMessage(signupMessage, 'يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.', 'warning', false);
                return;
            }
             if (!authInitialized) {
                 console.error("[Auth] Signup attempt failed: Auth service not initialized.");
                 setTemporaryMessage(signupMessage, 'خدمة المصادقة غير جاهزة. حاول لاحقاً.', 'error', false);
                 return;
            }

            showGlobalStatus('جاري إنشاء الحساب...', 'info', 0);

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Success: onAuthStateChanged will handle UI
                    console.log("[Auth] Signup successful for:", userCredential.user.email, "UID:", userCredential.user.uid);
                    // hideGlobalStatus() will be called by onAuthStateChanged handler
                })
                .catch((error) => {
                    hideGlobalStatus();
                    console.error("[Auth] Signup Error:", error.code, error.message);
                    let message = 'فشل إنشاء الحساب. ';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            message += 'هذا البريد الإلكتروني مستخدم بالفعل.';
                            break;
                        case 'auth/invalid-email':
                            message += 'صيغة البريد الإلكتروني غير صالحة.';
                            break;
                        case 'auth/weak-password':
                            message += 'كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).';
                            break;
                         case 'auth/network-request-failed':
                            message += 'فشل الاتصال بالشبكة. تحقق من اتصالك بالإنترنت.';
                            break;
                        default:
                             message += `حدث خطأ غير متوقع (${error.code}).`;
                    }
                    setTemporaryMessage(signupMessage, message, 'error', false, 5000);
                });
        }

        function handleLogout() {
             if (!authInitialized) {
                 console.error("[Auth] Logout attempt failed: Auth service not initialized.");
                 showGlobalStatus('خدمة المصادقة غير جاهزة.', 'error', 3000);
                 return;
            }
            console.log("[Auth] Attempting logout...");
            showGlobalStatus('جاري تسجيل الخروج...', 'info', 0);
            signOut(auth).then(() => {
                // Success: onAuthStateChanged will handle UI
                console.log("[Auth] User logged out successfully.");
                // hideGlobalStatus() will be called by onAuthStateChanged handler
            }).catch((error) => {
                hideGlobalStatus();
                console.error("[Auth] Logout Error:", error);
                showGlobalStatus('فشل تسجيل الخروج.', 'error', 3000);
            });
        }

        // --- Word Management Functions --- (Add logging inside if needed)
        async function handlePaste() {
             console.log("[UI] Paste button clicked.");
             pasteMessage.textContent = '';
            if (!navigator.clipboard || !navigator.clipboard.readText) {
                console.warn("[UI] Clipboard API not supported or not HTTPS.");
                setTemporaryMessage(pasteMessage, 'المتصفح لا يدعم اللصق التلقائي أو أنك لا تستخدم HTTPS.', 'warning', true, 5000);
                return;
            }
            try {
                const text = await navigator.clipboard.readText();
                console.log("[UI] Text pasted from clipboard:", text.substring(0, 50) + "..."); // Log first 50 chars
                if (text) {
                    bulkInput.value += (bulkInput.value ? '\n' : '') + text;
                    setTemporaryMessage(pasteMessage, 'تم اللصق بنجاح.', 'success', true);
                    bulkInput.scrollTop = bulkInput.scrollHeight;
                } else {
                    setTemporaryMessage(pasteMessage, 'الحافظة فارغة.', 'info', true);
                }
            } catch (err) {
                console.error("[UI] Clipboard paste error:", err);
                setTemporaryMessage(pasteMessage, 'فشل اللصق. قد تحتاج إلى منح الإذن للموقع للوصول إلى الحافظة.', 'error', true, 5000);
            }
        }

        async function addWordsFromText() {
            console.log("[Function] addWordsFromText called.");
            if (!firestoreInitialized || !currentUserId) {
                console.warn("[Function] addWordsFromText: Aborted - Firestore not ready or user not logged in.");
                setTemporaryMessage(addMessage, 'يجب تسجيل الدخول أولاً لإضافة الكلمات.', 'warning', false);
                return;
            }
             if (!bulkInput || !addBulkBtn || !addBtnText || !addBtnLoader || !addMessage) {
                 console.error("[Function] addWordsFromText: Missing required UI elements.");
                 setTemporaryMessage(addMessage,"خطأ في واجهة المستخدم.", 'error', false);
                 return;
             }

            const text = bulkInput.value.trim();
            if (!text) {
                console.log("[Function] addWordsFromText: Input text is empty.");
                setTemporaryMessage(addMessage, "الرجاء إدخال أو لصق النص أولاً.", "warning", false);
                return;
            }

            toggleButtonLoading(addBulkBtn, addBtnText, addBtnLoader, true, 'جار الإضافة...');
            setTemporaryMessage(addMessage, 'جاري تحليل وإضافة الكلمات...', 'info', false);
            console.log("[Function] addWordsFromText: Processing text:\n", text);

            const lines = text.split('\n');
            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            for (const [index, line] of lines.entries()) {
                const trimmedLine = line.trim();
                 console.log(`[Processing Line ${index + 1}] Raw: "${line}", Trimmed: "${trimmedLine}"`);
                if (!trimmedLine || trimmedLine.startsWith('#') || trimmedLine.startsWith('//')) {
                     console.log(`[Processing Line ${index + 1}] Skipping: Empty or comment.`);
                    continue;
                }

                const parts = trimmedLine.split(/\s*[:=\t]\s*/, 2);
                console.log(`[Processing Line ${index + 1}] Split parts:`, parts);

                if (parts.length === 2) {
                    const word = parts[0].trim();
                    const translation = parts[1].trim();
                     console.log(`[Processing Line ${index + 1}] Parsed - Word: "${word}", Translation: "${translation}"`);

                    if (word && translation) {
                        try {
                            const exists = await checkWordExists(word);
                            if (!exists) {
                                const addedDoc = await addWordFirestore({ word, translation });
                                if (addedDoc) {
                                    addedCount++;
                                } else {
                                    errorCount++; // Error message shown by addWordFirestore
                                }
                            } else {
                                console.log(`[Processing Line ${index + 1}] Skipping: Word "${word}" already exists.`);
                                skippedCount++;
                            }
                        } catch (err) {
                             console.error(`[Processing Line ${index + 1}] Error processing word "${word}":`, err);
                             setTemporaryMessage(addMessage, `خطأ غير متوقع عند معالجة كلمة "${word}".`, 'error', false);
                             errorCount++;
                        }
                    } else {
                         console.log(`[Processing Line ${index + 1}] Skipping: Empty word or translation after trim.`);
                        skippedCount++;
                    }
                } else {
                     console.log(`[Processing Line ${index + 1}] Skipping: Invalid format (no valid delimiter).`);
                    skippedCount++;
                }
            } // End loop

            console.log(`[Function] addWordsFromText: Finished processing. Added: ${addedCount}, Skipped: ${skippedCount}, Errors: ${errorCount}`);
            // Construct and display final message (logic remains the same)
             let messageText = '';
            let messageClass = 'default';
            if (errorCount > 0) { messageText += `حدث ${errorCount} خطأ. `; messageClass = 'error'; }
            if (addedCount > 0) { messageText += `تمت إضافة ${addedCount} كلمة. `; if (messageClass !== 'error') messageClass = 'success'; }
            if (skippedCount > 0) { messageText += `تم تخطي ${skippedCount} سطراً. `; if (messageClass === 'default') messageClass = 'warning'; }
            const nonEmptyLines = lines.filter(l => l.trim() && !l.trim().startsWith('#') && !l.trim().startsWith('//')).length;
             if (addedCount === 0 && skippedCount === 0 && errorCount === 0 && nonEmptyLines > 0) { messageText = "لم يتم العثور على كلمات صالحة للإضافة."; messageClass = 'warning'; }
             else if (nonEmptyLines === 0 && text) { messageText = "النص المدخل فارغ أو يحتوي فقط على تعليقات."; messageClass = 'info'; }
             else if (!messageText.trim()) { messageText = "لم تتم إضافة أو تخطي أي كلمات."; messageClass = 'info'; }
             setTemporaryMessage(addMessage, messageText.trim() || "اكتملت المعالجة.", messageClass, false, 5000);

            if (addedCount > 0) {
                bulkInput.value = ''; // Clear input on success
            }
            toggleButtonLoading(addBulkBtn, addBtnText, addBtnLoader, false);
        }

        // --- Review Session Functions --- (Add logging inside if needed)
        async function startSession() {
            console.log("[Function] startSession called.");
            if (!firestoreInitialized || !currentUserId) {
                 console.warn("[Function] startSession: Aborted - Firestore not ready or user not logged in.");
                setSessionMessage('يجب تسجيل الدخول أولاً لبدء المراجعة.', 'warning');
                if(flashcardContainer) flashcardContainer.classList.add('hidden');
                if(wordDisplayCard) wordDisplayCard.classList.add('hidden');
                return;
            }

            if(hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
            if(copyMessage) copyMessage.textContent = '';
            setSessionMessage('جاري تحميل الكلمات للمراجعة...', 'info');
            if(flashcardContainer) flashcardContainer.classList.add('hidden');
            if(wordDisplayCard) wordDisplayCard.classList.add('hidden');

            try {
                currentSessionWords = await getHardWordsFirestore();

                if (currentSessionWords === null) {
                     console.error("[Function] startSession: Failed to get hard words.");
                     // Error message already set
                     if(flashcardContainer) flashcardContainer.classList.add('hidden');
                     if(wordDisplayCard) wordDisplayCard.classList.add('hidden');
                     return;
                }

                if (currentSessionWords.length === 0) {
                     console.log("[Function] startSession: No hard words to review.");
                    setSessionMessage('لا توجد كلمات للمراجعة حالياً. أحسنت!', 'success');
                    if(flashcardContainer) flashcardContainer.classList.add('hidden');
                    if(wordDisplayCard) wordDisplayCard.classList.add('hidden');
                     if (mainHeading) mainHeading.classList.remove('hidden');
                    return;
                }

                console.log(`[Function] startSession: Starting review with ${currentSessionWords.length} words.`);
                currentWordIndex = 0;
                setSessionMessage('', 'default'); // Clear loading message
                displayCurrentWord();
                showPage('pageReview');

            } catch (error) {
                console.error("[Function] Error starting review session:", error);
                setSessionMessage('حدث خطأ غير متوقع أثناء بدء المراجعة.', 'error');
                 if(flashcardContainer) flashcardContainer.classList.add('hidden');
                 if(wordDisplayCard) wordDisplayCard.classList.add('hidden');
            }
        }

        function displayCurrentWord() {
             console.log(`[Function] displayCurrentWord: Index ${currentWordIndex}, Total words: ${currentSessionWords.length}`);
            if (currentWordIndex >= currentSessionWords.length) {
                 console.log("[Function] displayCurrentWord: Reached end of session.");
                endSession();
                return;
            }

            const currentWord = currentSessionWords[currentWordIndex];
            if (!currentWord || !currentWord.word || !currentWord.translation || !currentWord.id) {
                 console.error("[Function] displayCurrentWord: Invalid word data found at index", currentWordIndex, ":", currentWord);
                 setSessionMessage("خطأ: بيانات الكلمة غير صالحة. الانتقال للتالي...", "error");
                 setTimeout(goToNextWord, 500);
                 return;
            }
             console.log(`[Function] displayCurrentWord: Displaying word "${currentWord.word}" (ID: ${currentWord.id})`);

            if (wordDisplayLarge) wordDisplayLarge.textContent = currentWord.word;
            if (translationDisplay) {
                translationDisplay.textContent = currentWord.translation;
                translationDisplay.classList.add('hidden');
            }
            if (progressDisplay) progressDisplay.textContent = `الكلمة ${currentWordIndex + 1} / ${currentSessionWords.length}`;

            if (wordDisplayCard) wordDisplayCard.classList.remove('hidden');
            if (flashcardContainer) flashcardContainer.classList.remove('hidden');
            if (flashcardContainer && flashcardContainer.parentElement) {
                flashcardContainer.parentElement.classList.remove('hidden');
            }
            if (mainHeading) mainHeading.classList.add('hidden');

            if (markEasyBtn) markEasyBtn.disabled = false;
            if (markHardBtn) markHardBtn.disabled = false;
            if (showTranslationBtn) showTranslationBtn.classList.remove('hidden');
        }

        function handleShowTranslation() {
            console.log("[UI] Toggle translation visibility.");
            if (translationDisplay) {
                translationDisplay.classList.toggle('hidden');
            }
        }

        async function markWordAsEasy() {
            const wordObj = currentSessionWords[currentWordIndex];
             console.log(`[Function] markWordAsEasy called for word: ${wordObj?.word} (ID: ${wordObj?.id})`);
            if (!firestoreInitialized || !currentUserId) {
                console.warn("[Function] markWordAsEasy: Aborted - Firestore not ready or user not logged in.");
                setSessionMessage('خطأ اتصال، لا يمكن تحديث حالة الكلمة.', 'error');
                return;
            }
            if (currentWordIndex >= currentSessionWords.length) return;

            if (markEasyBtn) markEasyBtn.disabled = true;
            if (markHardBtn) markHardBtn.disabled = true;

            if (!wordObj || !wordObj.id) {
                 console.error("[Function] markWordAsEasy: Invalid current word object.");
                 setSessionMessage("خطأ: بيانات الكلمة الحالية غير صالحة.", "error");
                 if (markEasyBtn) markEasyBtn.disabled = false;
                 if (markHardBtn) markHardBtn.disabled = false;
                 return;
             }

            try {
                await updateWordStatusFirestore(wordObj.id, 'easy');
                goToNextWord();
            } catch(error) {
                 console.error("[Function] markWordAsEasy: Error updating status.", error);
                 // Error message set by updateWordStatusFirestore
                 if (markEasyBtn) markEasyBtn.disabled = false;
                 if (markHardBtn) markHardBtn.disabled = false;
            }
        }

        function markWordAsHard() {
            const wordObj = currentSessionWords[currentWordIndex];
            console.log(`[Function] markWordAsHard called for word: ${wordObj?.word} (ID: ${wordObj?.id})`);
            if (currentWordIndex >= currentSessionWords.length) return;

            if (!wordObj || !wordObj.word) {
                  console.error("[Function] markWordAsHard: Invalid current word object.");
                  setSessionMessage("خطأ: بيانات الكلمة الحالية غير صالحة.", "error");
                  goToNextWord();
                  return;
             }

            if (markEasyBtn) markEasyBtn.disabled = true;
            if (markHardBtn) markHardBtn.disabled = true;

            if (translationDisplay && translationDisplay.classList.contains('hidden')) {
                translationDisplay.classList.remove('hidden');
            }

            const delay = 1000;
            console.log(`[Function] markWordAsHard: Delaying ${delay}ms before next word.`);
            setTimeout(() => {
                goToNextWord();
            }, delay);
        }

        function goToNextWord() {
             console.log("[Function] goToNextWord called.");
             currentWordIndex++;
             if (wordDisplayCard) {
                 wordDisplayCard.style.opacity = '0';
                 wordDisplayCard.style.transition = 'opacity 0.15s ease-out';
             }
             setTimeout(() => {
                 displayCurrentWord();
                 if (wordDisplayCard && !wordDisplayCard.classList.contains('hidden')) {
                     wordDisplayCard.style.transition = 'opacity 0.25s ease-in';
                     wordDisplayCard.style.opacity = '1';
                 }
             }, 150);
        }

        async function endSession() {
             console.log("[Function] endSession called.");
             if (flashcardContainer) flashcardContainer.classList.add('hidden');
             if (wordDisplayCard) wordDisplayCard.classList.add('hidden');
             if (mainHeading) mainHeading.classList.remove('hidden');

             setSessionMessage('رائع! اكتملت جلسة المراجعة هذه.', 'success');

             if (!firestoreInitialized || !currentUserId) {
                 console.warn("[Function] endSession: Cannot fetch remaining words - Firestore not ready or user not logged in.");
                 setSessionMessage('اكتملت الجلسة (لا يمكن عرض القائمة المتبقية - خطأ اتصال أو تسجيل دخول).', 'warning');
                 return;
             }

             setSessionMessage('جاري تحديث قائمة الكلمات الصعبة...', 'info');

             try {
                 const remainingHardWords = await getHardWordsFirestore();
                  if (remainingHardWords === null) {
                     console.error("[Function] endSession: Failed to get remaining hard words.");
                     setSessionMessage('اكتملت الجلسة (خطأ في جلب الكلمات المتبقية).', 'warning');
                     if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                     return;
                 }

                 console.log(`[Function] endSession: ${remainingHardWords.length} hard words remaining.`);
                 if (remainingHardWords.length > 0) {
                     const formattedList = remainingHardWords
                         .map(item => `${item.word} : ${item.translation}`)
                         .join('\n');
                     if (hardWordsOutput) hardWordsOutput.value = formattedList;
                     if (hardWordsListContainer) hardWordsListContainer.classList.remove('hidden');
                     setSessionMessage(`اكتملت الجلسة. الكلمات المتبقية للمراجعة (${remainingHardWords.length}):`, 'info');
                 } else {
                     if (hardWordsOutput) hardWordsOutput.value = '';
                     if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                     setSessionMessage('ممتاز! لقد أتقنت كل الكلمات الصعبة.', 'success');
                 }
             } catch (error) {
                 console.error("[Function] Error fetching remaining hard words after session:", error);
                 if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                 setSessionMessage('اكتملت الجلسة (حدث خطأ غير متوقع في عرض الكلمات المتبقية).', 'warning');
             }
        }

        // --- Hard Words List Functions --- (Add logging inside if needed)
        async function handleCopyHardWords() {
            console.log("[UI] Copy hard words button clicked.");
            if (!hardWordsOutput || !copyMessage) return;
            copyMessage.textContent = '';

            const textToCopy = hardWordsOutput.value;
            if (!textToCopy) {
                setTemporaryMessage(copyMessage, 'لا توجد كلمات لنسخها.', 'warning', true);
                return;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    console.log("[UI] Hard words copied to clipboard successfully.");
                    setTemporaryMessage(copyMessage, 'تم نسخ القائمة بنجاح!', 'success', true);
                } catch (err) {
                    console.error("[UI] Clipboard API writeText failed:", err);
                    setTemporaryMessage(copyMessage, 'فشل النسخ التلقائي. حاول النسخ يدوياً.', 'error', true);
                    trySelectText(hardWordsOutput);
                }
            } else {
                 console.warn("[UI] Clipboard API not available. Falling back to text selection.");
                setTemporaryMessage(copyMessage, 'المتصفح لا يدعم النسخ التلقائي. حاول النسخ يدوياً.', 'warning', true);
                trySelectText(hardWordsOutput);
            }
        }

        function trySelectText(element) {
            try {
                element.select();
                element.setSelectionRange(0, 99999); // For mobile
                 console.log("[UI] Fallback: Text selected for manual copy.");
            } catch (e) {
                console.warn("[UI] Fallback text selection failed:", e);
                setTemporaryMessage(copyMessage, 'فشل تحديد النص للنسخ اليدوي.', 'error', true);
            }
        }

        async function showHardWordsList() {
             console.log("[Function] showHardWordsList called.");
             if (!firestoreInitialized || !currentUserId) {
                  console.warn("[Function] showHardWordsList: Aborted - Firestore not ready or user not logged in.");
                 showGlobalStatus('يجب تسجيل الدخول أولاً لعرض الكلمات الصعبة.', 'warning', 3000);
                 return;
             }
            showPage('pageReview');

            if (flashcardContainer) flashcardContainer.classList.add('hidden');
            if (wordDisplayCard) wordDisplayCard.classList.add('hidden');
            if (mainHeading) mainHeading.classList.remove('hidden');
            if (copyMessage) copyMessage.textContent = '';

            setSessionMessage('جاري تحميل الكلمات الصعبة...', 'info');
            if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');

            try {
                const hardWords = await getHardWordsFirestore();
                if (hardWords === null) {
                     console.error("[Function] showHardWordsList: Failed to get hard words.");
                    setSessionMessage('خطأ في جلب الكلمات الصعبة.', 'error');
                    return;
                }

                 console.log(`[Function] showHardWordsList: Displaying ${hardWords.length} hard words.`);
                if (hardWords.length > 0) {
                    const formattedList = hardWords
                        .map(item => `${item.word} : ${item.translation}`)
                        .join('\n');
                    if (hardWordsOutput) hardWordsOutput.value = formattedList;
                    if (hardWordsListContainer) hardWordsListContainer.classList.remove('hidden');
                    setSessionMessage(`الكلمات الصعبة (${hardWords.length}):`, 'info');
                } else {
                    if (hardWordsOutput) hardWordsOutput.value = '';
                    if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                    setSessionMessage('لا توجد كلمات صعبة حالياً. أحسنت!', 'success');
                }
            } catch (error) {
                console.error("[Function] Error showing hard words list:", error);
                if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                setSessionMessage('حدث خطأ غير متوقع أثناء عرض الكلمات الصعبة.', 'error');
            }
        }

        // --- Initialization and Event Listeners ---
        function assignElementRefs() {
            console.log("[Init] Assigning DOM element references.");
            authSection = document.getElementById('authSection');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginBtn = document.getElementById('loginBtn');
            loginMessage = document.getElementById('loginMessage');
            showSignupBtn = document.getElementById('showSignupBtn');
            signupEmailInput = document.getElementById('signupEmail');
            signupPasswordInput = document.getElementById('signupPassword');
            signupBtn = document.getElementById('signupBtn');
            signupMessage = document.getElementById('signupMessage');
            showLoginBtn = document.getElementById('showLoginBtn');
            authStatus = document.getElementById('authStatus');
            userEmailDisplay = document.getElementById('userEmailDisplay');
            logoutBtn = document.getElementById('logoutBtn');
            mainAppContainer = document.getElementById('mainAppContainer');
            globalStatus = document.getElementById('globalStatus');
            mainHeading = document.querySelector('.heading-1');
            pageAddWords = document.getElementById('pageAddWords');
            pageReview = document.getElementById('pageReview');
            gotoAddBtn_FromReview = document.getElementById('gotoAddBtn_FromReview');
            gotoReviewBtn_FromAdd = document.getElementById('gotoReviewBtn_FromAdd');
            bulkInput = document.getElementById('bulkInput');
            pasteBtn = document.getElementById('pasteBtn');
            pasteMessage = document.getElementById('pasteMessage');
            addBulkBtn = document.getElementById('addBulkBtn');
            addBtnText = document.getElementById('addBtnText');
            addBtnLoader = document.getElementById('addBtnLoader');
            addMessage = document.getElementById('addMessage');
            wordDisplayCard = document.getElementById('wordDisplayCard');
            wordDisplayLarge = document.getElementById('wordDisplayLarge');
            flashcardContainer = document.getElementById('flashcardContainer');
            progressDisplay = document.getElementById('progressDisplay');
            translationDisplay = document.getElementById('translationDisplay');
            showTranslationBtn = document.getElementById('showTranslationBtn');
            difficultyButtonsContainer = document.getElementById('difficultyButtonsContainer');
            markEasyBtn = document.getElementById('markEasyBtn');
            markHardBtn = document.getElementById('markHardBtn');
            sessionMessage = document.getElementById('sessionMessage');
            hardWordsListContainer = document.getElementById('hardWordsListContainer');
            hardWordsOutput = document.getElementById('hardWordsOutput');
            copyHardWordsBtn = document.getElementById('copyHardWordsBtn');
            copyMessage = document.getElementById('copyMessage');
            gotoHardWordsBtn = document.getElementById('gotoHardWordsBtn');

             // Check if essential elements were found
             if (!authSection || !mainAppContainer || !globalStatus) {
                 console.error("[Init] Critical UI elements not found! App may not function correctly.");
             }
        }


        function setupAuthUI() {
             console.log("[Init] Setting up Auth UI event listeners.");
            if (showSignupBtn) showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if(loginForm) loginForm.classList.add('hidden');
                if(signupForm) signupForm.classList.remove('hidden');
                if(loginMessage) loginMessage.textContent = '';
            });
            if (showLoginBtn) showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if(signupForm) signupForm.classList.add('hidden');
                if(loginForm) loginForm.classList.remove('hidden');
                if(signupMessage) signupMessage.textContent = '';
            });
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (signupForm) signupForm.addEventListener('submit', handleSignup);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        }

        function setupAppUI() {
            console.log("[Init] Setting up App UI event listeners.");
             if (gotoAddBtn_FromReview) gotoAddBtn_FromReview.addEventListener('click', () => showPage('pageAddWords'));
             if (gotoReviewBtn_FromAdd) gotoReviewBtn_FromAdd.addEventListener('click', startSession);
             if (pasteBtn) pasteBtn.addEventListener('click', handlePaste);
             if (addBulkBtn) addBulkBtn.addEventListener('click', addWordsFromText);
             if (showTranslationBtn) showTranslationBtn.addEventListener('click', handleShowTranslation);
             if (markEasyBtn) markEasyBtn.addEventListener('click', markWordAsEasy);
             if (markHardBtn) markHardBtn.addEventListener('click', markWordAsHard);
             if (copyHardWordsBtn) copyHardWordsBtn.addEventListener('click', handleCopyHardWords);
             if (gotoHardWordsBtn) gotoHardWordsBtn.addEventListener('click', showHardWordsList);
        }

        // --- Main Execution Flow ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[Init] DOMContentLoaded event fired.");
            assignElementRefs(); // Get references to all needed elements

            // Initialize Firebase
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId || !firebaseConfig.authDomain) {
                    throw new Error("Firebase config is missing required fields.");
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firestoreInitialized = true;
                authInitialized = true;
                console.log("[Init] Firebase initialized successfully.");
                showGlobalStatus('Firebase جاهز.', 'success', 2000); // Short success message
            } catch (error) {
                console.error("[Init] Firebase Initialization Error:", error);
                firestoreInitialized = false;
                authInitialized = false;
                showGlobalStatus(`فشل تهيئة Firebase: ${error.message}. التطبيق لن يعمل.`, 'error', 0); // Show persistent error
                // Disable interactions if Firebase fails
                document.querySelectorAll('button, input, textarea').forEach(el => el.disabled = true);
                return; // Stop further execution
            }

            // Setup UI listeners
            setupAuthUI();
            setupAppUI();

            // --- Firebase Auth State Listener ---
            console.log("[Init] Setting up onAuthStateChanged listener.");
            onAuthStateChanged(auth, (user) => {
                 // This should hide any persistent loading message from init
                hideGlobalStatus();

                if (user) {
                    // --- User is Signed In ---
                    console.log("[Auth] State Change: User IS signed in -", user.uid, user.email);
                    currentUserId = user.uid;
                    if (userEmailDisplay) userEmailDisplay.textContent = user.email || 'المستخدم';

                    // --- Update UI for logged-in state ---
                    if (authSection) authSection.classList.add('hidden');
                    if (mainAppContainer) {
                        mainAppContainer.classList.remove('hidden');
                        mainAppContainer.style.opacity = '0';
                        setTimeout(() => { if(mainAppContainer) mainAppContainer.style.opacity = '1'; }, 50);
                    }
                     if (gotoHardWordsBtn) gotoHardWordsBtn.classList.remove('hidden');

                    // --- Reset app state ---
                    currentSessionWords = [];
                    currentWordIndex = 0;
                    if (hardWordsListContainer) hardWordsListContainer.classList.add('hidden');
                    if (sessionMessage) sessionMessage.textContent = '';
                    if (addMessage) addMessage.textContent = '';
                    if (bulkInput) bulkInput.value = '';

                    // Default to Add Words page
                    showPage('pageAddWords');

                } else {
                    // --- User is Signed Out ---
                    console.log("[Auth] State Change: User IS signed out.");
                    currentUserId = null;

                    // --- Update UI for logged-out state ---
                    if (mainAppContainer) mainAppContainer.classList.add('hidden');
                    if (authSection) authSection.classList.remove('hidden');
                    if (signupForm) signupForm.classList.add('hidden');
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (loginMessage) loginMessage.textContent = '';
                    if (signupMessage) signupMessage.textContent = '';

                    // Reset state
                    currentSessionWords = [];
                    currentWordIndex = 0;
                    if (gotoHardWordsBtn) gotoHardWordsBtn.classList.add('hidden');
                }
            }, (error) => {
                // Handle errors during the listener setup or execution
                console.error("[Auth] Error in onAuthStateChanged listener:", error);
                showGlobalStatus('حدث خطأ في مراقبة حالة المصادقة.', 'error', 0);
            });

            console.log("[Init] Initialization complete. Waiting for auth state...");

        }); // End DOMContentLoaded

    </script>
</body>
</html>

