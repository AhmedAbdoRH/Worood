<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراجعة الكلمات (HTML/CSS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            /* Define color palette for easy modification */
            --bg-dark-primary: #111827; /* gray-900 */
            --bg-dark-secondary: #1f2937; /* gray-800 */
            --bg-dark-tertiary: #374151; /* gray-700 */
            --bg-dark-quaternary: #4b5563; /* gray-600 */
            --border-dark: #374151; /* gray-700 */
            --border-dark-focus: #60a5fa; /* blue-400 for focus */
            --text-light-primary: #e5e7eb; /* gray-200 */
            --text-light-secondary: #d1d5db; /* gray-300 */
            --text-light-tertiary: #9ca3af; /* gray-400 */
            --text-placeholder: #6b7280; /* gray-500 */
            --primary-color: #3b82f6; /* blue-600 */
            --primary-color-hover: #2563eb; /* blue-700 */
            --secondary-color: #4b5563; /* gray-600 */
            --secondary-color-hover: #374151; /* gray-700 */
            --success-color: #16a34a; /* green-600 */
            --success-color-hover: #15803d; /* green-700 */
            --danger-color: #dc2626; /* red-600 */
            --danger-color-hover: #b91c1c; /* red-700 */
            --danger-outline-color: #f87171; /* red-400 */
            --danger-outline-hover-bg: rgba(220, 38, 38, 0.1); /* red-600 with alpha */

            --font-family-base: 'Cairo', sans-serif;
            --border-radius-lg: 0.75rem; /* rounded-xl */
            --border-radius-md: 0.5rem; /* rounded-lg */
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Basic reset and body styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            background-color: var(--bg-dark-primary);
            color: var(--text-light-primary);
            font-family: var(--font-family-base);
            line-height: 1.5;
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            background-image: linear-gradient(to bottom right, var(--bg-dark-primary), #000);
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important; /* Ensure override */
        }

        .container {
            width: 100%;
            max-width: 36rem; /* max-w-lg */
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) { /* md breakpoint */
             .container {
                 max-width: 42rem; /* max-w-xl */
             }
        }


        /* --- Page Structure --- */
        .page {
            transition: opacity 0.3s ease-in-out;
        }

        /* --- Headings --- */
        .heading-1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            text-align: center;
            color: var(--border-dark-focus); /* Using focus color for title */
            margin-bottom: 1rem; /* mb-4 */
        }
         @media (min-width: 768px) { /* md breakpoint */
            .heading-1 {
                 font-size: 2.25rem; /* text-4xl */
                 margin-bottom: 1.5rem; /* mb-6 */
            }
         }

        .heading-2 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: var(--text-light-primary);
            margin-bottom: 0.75rem; /* mb-3 */
        }
         @media (min-width: 768px) { /* md breakpoint */
             .heading-2 {
                 font-size: 1.25rem; /* text-xl */
             }
         }

        /* --- Card Styles --- */
        .card {
            background-color: var(--bg-dark-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 1.25rem; /* p-5 */
            transition: all 0.3s ease-in-out;
            border: 1px solid var(--border-dark);
            text-align: center; /* Default for review card */
        }
        .card--add { /* Specific styles for add card if needed */
             text-align: right; /* Override for add card */
             margin-bottom: 1rem; /* mb-4 */
        }
         @media (min-width: 768px) { /* md breakpoint */
             .card {
                 padding: 1.5rem; /* p-6 */
             }
         }

        /* --- Button Styles --- */
        .btn {
            display: inline-flex; /* Use inline-flex for icon alignment */
            align-items: center;
            justify-content: center;
            gap: 0.25rem; /* gap-1 */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: var(--border-radius-md);
            font-weight: 600;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
            border: none; /* Remove default border */
            cursor: pointer;
            font-size: 0.75rem; /* text-xs */
            line-height: 1.25; /* Ensure consistent height */
            text-decoration: none; /* Remove underline from potential links */
        }
         @media (min-width: 768px) { /* md breakpoint */
             .btn {
                 font-size: 0.875rem; /* text-sm */
                 gap: 0.5rem; /* gap-2 */
             }
         }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--border-dark-focus); /* Custom focus ring */
        }

        .btn--sm {
            padding: 0.375rem 0.75rem; /* px-3 py-1.5 */
            font-size: 0.75rem; /* text-xs */
            gap: 0.25rem; /* gap-1 */
            border-radius: 0.375rem; /* rounded-md */
        }

        .btn--primary {
            background-color: var(--primary-color);
        }
        .btn--primary:hover:not(:disabled) {
            background-color: var(--primary-color-hover);
        }

        .btn--secondary {
            background-color: var(--secondary-color);
        }
        .btn--secondary:hover:not(:disabled) {
            background-color: var(--secondary-color-hover);
        }

        .btn--action { /* Specific style for Easy/Hard buttons */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 700;
            border-radius: var(--border-radius-md);
            gap: 0.25rem; /* gap-1 */
        }
        .btn--action:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .btn--success {
            background-color: var(--success-color);
        }
        .btn--success:hover:not(:disabled) {
            background-color: var(--success-color-hover);
        }
        .btn--success:focus {
             box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--success-color);
        }

        .btn--danger {
             background-color: var(--danger-color);
        }
        .btn--danger:hover:not(:disabled) {
             background-color: var(--danger-color-hover);
        }
         .btn--danger:focus {
             box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--danger-color);
        }

        .btn--danger-outline {
            background-color: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-outline-color);
        }
        .btn--danger-outline:hover:not(:disabled) {
            background-color: var(--danger-outline-hover-bg);
        }
        .btn--danger-outline:focus {
             box-shadow: 0 0 0 3px var(--bg-dark-primary), 0 0 0 5px var(--danger-color);
        }

        .btn--full-width {
            width: 100%;
        }

        /* --- Form Elements --- */
        .label {
            display: block;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            color: var(--text-light-secondary);
            margin-bottom: 0.25rem; /* mb-1 */
        }

        .input-field, .textarea-field {
            margin-top: 0.25rem; /* mt-1 */
            display: block;
            width: 100%;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            background-color: var(--bg-dark-primary); /* Darker input bg */
            border: 1px solid var(--border-dark);
            border-radius: var(--border-radius-md);
            font-size: 0.875rem; /* text-sm */
            box-shadow: var(--shadow-sm); /* Approximation */
            color: var(--text-light-primary);
        }
        .textarea-field {
            min-height: 80px; /* Approximation for rows="5" */
            line-height: 1.5;
        }

        .input-field::placeholder, .textarea-field::placeholder {
            color: var(--text-placeholder);
        }

        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: var(--border-dark-focus);
            box-shadow: 0 0 0 1px var(--border-dark-focus);
        }

        .textarea-readonly {
            background-color: var(--bg-dark-tertiary);
            border-color: var(--border-dark);
            color: var(--text-light-secondary);
            cursor: default;
        }
        .textarea-readonly:focus {
             border-color: var(--border-dark); /* No focus change */
             box-shadow: none;
        }

        /* Relative positioning removed for paste button */
        .input-container {
            /* position: relative;  <-- REMOVED */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        /* Absolute positioning removed */
        /* .paste-button-container {
            position: absolute;
            top: 1.6rem;
            left: 0.5rem;
        } */


        /* --- Message Styles --- */
        .message {
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
            min-height: 1rem; /* h-4 */
        }
        .message--small {
             margin-top: 0.25rem; /* mt-1 */
             min-height: 0.75rem; /* h-3 */
        }
        .message--success { color: var(--success-color); }
        .message--error { color: var(--danger-color); }
        .message--info { color: var(--text-light-secondary); }
        .message--warning { color: #facc15; } /* yellow-400 */
        .message--default { color: var(--text-light-tertiary); }

        /* --- Flashcard Styles --- */
        .flashcard-content {
            background-color: var(--bg-dark-tertiary);
            border-radius: var(--border-radius-lg);
            padding: 1rem; /* p-4 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--bg-dark-quaternary);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* shadow-inner approximation */
            margin-bottom: 0.75rem; /* mb-3 */
            min-height: 220px;
            transition: opacity 0.15s ease-in-out;
        }
         @media (min-width: 768px) { /* md breakpoint */
             .flashcard-content {
                 padding: 1.5rem; /* p-6 */
             }
         }

        .word-display {
            font-size: 20rem; /* text-5xl */
            font-weight: 7000;
            color: white;
            margin-bottom: 0.5rem; /* mb-2 */
            text-align: center;
            word-break: break-word;
            line-height: 1; /* leading-none */
        }
        @media (min-width: 640px) { /* sm breakpoint */
             .word-display { font-size: 22.75rem; /* text-6xl */ }
        }
         @media (min-width: 1024px) { /* lg breakpoint */
             .word-display { font-size: 21.5rem; /* text-7xl */ }
         }


        .translation-display {
            font-size: 1rem; /* text-base */
            color: var(--text-light-secondary);
            text-align: center;
            word-break: break-word;
            margin-top: 0.25rem; /* mt-1 */
        }
         @media (min-width: 768px) { /* md breakpoint */
             .translation-display {
                 font-size: 1.125rem; /* text-lg */
             }
         }

        /* --- Layout Helpers --- */
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 0.5rem; /* mt-2 */
        }
        .margin-top-1 { margin-top: 0.25rem; }
        .margin-top-2 { margin-top: 0.5rem; }
        .margin-top-3 { margin-top: 0.75rem; }
        .margin-top-4 { margin-top: 1rem; }
        .margin-top-5 { margin-top: 1.25rem; }
        .margin-bottom-3 { margin-bottom: 0.75rem; }
        .margin-bottom-4 { margin-bottom: 1rem; }
        .padding-top-3 { padding-top: 0.75rem; }
        .padding-top-4 { padding-top: 1rem; }
        .border-top { border-top: 1px solid var(--border-dark); }

        /* --- Loader --- */
        .loader {
            display: inline-block;
            animation: spin 1s linear infinite;
            border-radius: 50%;
            width: 1rem; /* h-4 w-4 */
            height: 1rem;
            border-top: 2px solid white;
            border-bottom: 2px solid white;
            border-left: 2px solid transparent;
            border-right: 2px solid transparent;
            margin-left: 0.5rem; /* ml-2 if needed */
        }
        .btn .loader { margin-left: 0; } /* Reset margin if inside button */

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Small Text Utility --- */
        .small-text {
            font-size: 0.625rem; /* text-[10px] */
            color: var(--text-light-tertiary);
        }
         @media (min-width: 768px) { /* md breakpoint */
             .small-text {
                 font-size: 0.75rem; /* text-xs */
             }
         }

         /* --- Icon Styles (Basic Size) --- */
         .icon {
             width: 1rem; /* w-4 */
             height: 1rem; /* h-4 */
             display: inline-block;
             vertical-align: middle;
         }
         .icon--sm {
             width: 0.75rem; /* w-3 */
             height: 0.75rem; /* h-3 */
         }
         .icon--lg {
             width: 1.25rem; /* w-5 */
             height: 1.25rem; /* h-5 */
         }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="heading-1">
             أداة مراجعة الكلمات
        </h1>

        <div id="pageAddWords" class="page">
            <div class="card card--add">
                <h2 class="heading-2">1. إضافة كلمات جديدة</h2>
                <div class="input-container">
                    <label for="bulkInput" class="label">ألصق النص (كل سطر: كلمة فاصل ترجمة):</label>
                    <textarea id="bulkInput" class="textarea-field" rows="5" placeholder="مثال:&#10;Hello : مرحباً&#10;Book = كتاب&#10;World	عالم"></textarea>
                    </div>
                 <p id="pasteMessage" class="message message--small message--default"></p>

                <button id="addBulkBtn" class="btn btn--primary btn--full-width margin-top-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--lg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    <span id="addBtnText">إضافة الكلمات</span>
                    <span id="addBtnLoader" class="loader hidden"></span>
                </button>
                <p id="addMessage" class="message message--default"></p>

                <div class="paste-button-container margin-top-4">
                    <button id="pasteBtn" title="لصق من الحافظة" class="btn btn--secondary btn--sm btn--full-width">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon"><path fill-rule="evenodd" d="M15.99 4.01h-1.48a3.5 3.5 0 00-6.98 0H6.01a2 2 0 00-2 2v10a2 2 0 002 2h9.98a2 2 0 002-2V6.01a2 2 0 00-2-2zm-8.98 14V6.01h1.48v-.03a2 2 0 114 0v.03h1.48l.01 11.99H7.01zm4.49-11.03a.5.5 0 00-1 0v.03h1v-.03z" clip-rule="evenodd" /></svg>
                        <span>لصق من الحافظة</span>
                    </button>
                </div>

                <div class="margin-top-5 border-top padding-top-4">
                     <button id="gotoReviewBtn_FromAdd" class="btn btn--secondary btn--full-width margin-bottom-3">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon icon--lg"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.03a.75.75 0 000-1.5H4.333a.75.75 0 00-.75.75v3.167a.75.75 0 001.5 0v-2.03l.31.312a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm1.23-3.723a.75.75 0 00-1.449.389A7 7 0 003.028 10.07l-.31.311H4.75a.75.75 0 000-1.5H1.583a.75.75 0 00-.75.75v3.167a.75.75 0 001.5 0v-2.03l.312-.31a5.5 5.5 0 019.201-2.466.75.75 0 001.449-.39z" clip-rule="evenodd" /></svg>
                         بدء المراجعة مباشرة
                     </button>
                     </div>
            </div>
        </div>

        <div id="pageReview" class="page hidden">
            <div class="card">
                <button id="startSessionBtn" class="btn btn--primary btn--sm margin-bottom-4">
                     <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                     <span id="startBtnText">بدء جلسة جديدة</span>
                     <span id="startBtnLoader" class="loader hidden"></span>
                </button>

                <div id="flashcardContainer" class="hidden">
                    <p id="progressDisplay" class="small-text margin-bottom-3"></p>
                    <div id="flashcardContent">
                        <div id="wordDisplay"></div>
                        <div id="translationDisplay" class="hidden"></div>
                    </div>
                    <button id="showTranslationBtn" class="btn btn--secondary btn--sm margin-top-2">إظهار/إخفاء الترجمة</button>
                    <div id="difficultyButtonsContainer" class="button-group margin-top-2">
                         <button id="markHardBtn" class="btn btn--action btn--success"> <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"> <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /> </svg>
                             سهلة
                         </button>
                         <button id="markEasyBtn" class="btn btn--action btn--danger"> <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                             صعبة
                         </button>
                    </div>
                </div>
                 <p id="sessionMessage" class="message message--info"></p>

                 <div id="hardWordsListContainer" class="margin-top-4 border-top padding-top-3 hidden">
                     <h3 class="heading-2" style="font-size: 0.875rem; margin-bottom: 0.25rem;">الكلمات المتبقية:</h3>
                     <textarea id="hardWordsOutput" rows="4" readonly class="textarea-field textarea-readonly" style="font-size: 0.75rem;"></textarea>
                     <button id="copyHardWordsBtn" class="btn btn--secondary btn--sm margin-top-2">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon icon--sm"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z" /></svg>
                         نسخ
                     </button>
                     <p id="copyMessage" class="message message--small message--default"></p>
                 </div>

                 <button id="gotoAddBtn_FromReview" class="btn btn--secondary btn--full-width margin-top-4 btn--sm">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                     الذهاب إلى الإضافة
                 </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, query, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // WARNING: Insecure config. Use Auth and Rules in production.
        const firebaseConfig = {
            apiKey: "AIzaSyAunLxvASN6Cbsa_Nc6l78_5lMhe5fP2Qg", // Replace if needed
            authDomain: "momtn-ecab7.firebaseapp.com",
            projectId: "momtn-ecab7",
            storageBucket: "momtn-ecab7.appspot.com",
            messagingSenderId: "98544311111", // Replace if needed
            appId: "1:98544311111:web:0158668f45ae34818fca62", // Replace if needed
            measurementId: "G-W164SZBMDP" // Replace if needed
        };

        let app;
        let db;
        let firestoreInitialized = false;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            firestoreInitialized = true;
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        const WORDS_COLLECTION = 'userWords';

        async function checkWordExists(word) {
            if (!firestoreInitialized) return true; // Assume exists if DB failed
            const q = query(collection(db, WORDS_COLLECTION), where("word", "==", word));
            try {
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) { console.error("Error checking word existence:", error); return true; } // Assume exists on error
        }
        async function addWordFirestore(wordObject) {
            if (!firestoreInitialized) return Promise.reject("Firestore not initialized");
            // Ensure status is 'hard' when adding
            wordObject.status = 'hard';
            return addDoc(collection(db, WORDS_COLLECTION), wordObject);
        }
        async function getHardWordsFirestore() {
            if (!firestoreInitialized) return Promise.resolve([]);
            const q = query(collection(db, WORDS_COLLECTION), where("status", "==", "hard"));
            try {
                const querySnapshot = await getDocs(q);
                const words = [];
                querySnapshot.forEach((doc) => { words.push({ id: doc.id, ...doc.data() }); });
                return words;
            } catch (error) { console.error("Error getting hard words:", error); return []; }
        }
        async function updateWordStatusFirestore(docId, newStatus) {
            if (!firestoreInitialized) return Promise.reject("Firestore not initialized");
            const wordDocRef = doc(db, WORDS_COLLECTION, docId);
            return updateDoc(wordDocRef, { status: newStatus });
        }
        async function deleteAllWordsFirestore() {
            // This function remains but the button calling it is removed
            if (!firestoreInitialized) return Promise.reject("Firestore not initialized");
            const q = query(collection(db, WORDS_COLLECTION));
            try {
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((document) => { deletePromises.push(deleteDoc(doc(db, WORDS_COLLECTION, document.id))); });
                await Promise.all(deletePromises);
                return deletePromises.length;
            } catch (error) { console.error("Error deleting all words:", error); throw error; }
        }

        // DOM Elements
        const pageAddWords = document.getElementById('pageAddWords');
        const pageReview = document.getElementById('pageReview');
        const gotoAddBtn_FromReview = document.getElementById('gotoAddBtn_FromReview');
        const gotoReviewBtn_FromAdd = document.getElementById('gotoReviewBtn_FromAdd');
        const bulkInput = document.getElementById('bulkInput');
        const pasteBtn = document.getElementById('pasteBtn');
        const pasteMessage = document.getElementById('pasteMessage');
        const addBulkBtn = document.getElementById('addBulkBtn');
        const addBtnText = document.getElementById('addBtnText');
        const addBtnLoader = document.getElementById('addBtnLoader');
        const addMessage = document.getElementById('addMessage');
        // deleteAllBtn elements are removed from HTML, but keep JS vars if needed elsewhere (unlikely now)
        // const deleteAllBtn = document.getElementById('deleteAllBtn');
        // const deleteBtnText = document.getElementById('deleteBtnText');
        // const deleteBtnLoader = document.getElementById('deleteBtnLoader');
        // const deleteMessage = document.getElementById('deleteMessage');
        const startSessionBtn = document.getElementById('startSessionBtn');
        const startBtnText = document.getElementById('startBtnText');
        const startBtnLoader = document.getElementById('startBtnLoader');
        const flashcardContainer = document.getElementById('flashcardContainer');
        const progressDisplay = document.getElementById('progressDisplay');
        const flashcardContent = document.getElementById('flashcardContent');
        const wordDisplay = document.getElementById('wordDisplay');
        const translationDisplay = document.getElementById('translationDisplay');
        const showTranslationBtn = document.getElementById('showTranslationBtn');
        const difficultyButtonsContainer = document.getElementById('difficultyButtonsContainer');
        const markEasyBtn = document.getElementById('markEasyBtn'); // Represents 'Hard' (Red X)
        const markHardBtn = document.getElementById('markHardBtn'); // Represents 'Easy' (Green Check)
        const sessionMessage = document.getElementById('sessionMessage');
        const hardWordsListContainer = document.getElementById('hardWordsListContainer');
        const hardWordsOutput = document.getElementById('hardWordsOutput');
        const copyHardWordsBtn = document.getElementById('copyHardWordsBtn');
        const copyMessage = document.getElementById('copyMessage');

        let currentSessionWords = [];
        let currentWordIndex = 0;

        function showPage(pageId) {
            pageAddWords.classList.add('hidden');
            pageReview.classList.add('hidden');
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) { pageToShow.classList.remove('hidden'); }
        }

        function toggleButtonLoading(button, textElement, loaderElement, isLoading, loadingText = '') {
             if (!button || !textElement || !loaderElement) return; // Safety check
             const originalText = textElement.dataset.originalText || textElement.textContent;
             if (isLoading) {
                 loaderElement.classList.remove('hidden');
                 button.disabled = true;
                 if (!textElement.dataset.originalText) { textElement.dataset.originalText = originalText; }
                 textElement.textContent = loadingText;
             } else {
                 loaderElement.classList.add('hidden');
                 button.disabled = false;
                 if (textElement.dataset.originalText) { // Restore original text if it was saved
                     textElement.textContent = textElement.dataset.originalText;
                 }
             }
        }

        async function handlePaste() {
            pasteMessage.textContent = '';
            if (!navigator.clipboard || !navigator.clipboard.readText) {
                setTemporaryMessage(pasteMessage, 'المتصفح لا يدعم اللصق أو تحتاج لـ HTTPS.', 'message-warning', true); return;
            }
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                     bulkInput.value += (bulkInput.value ? '\n' : '') + text;
                     setTemporaryMessage(pasteMessage, 'تم اللصق بنجاح.', 'message-success', true);
                } else {
                    setTemporaryMessage(pasteMessage, 'الحافظة فارغة.', 'message-info', true);
                }
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                setTemporaryMessage(pasteMessage, 'فشل اللصق. قد تحتاج لإعطاء الإذن.', 'message-error', true);
            }
        }

        async function addWordsFromText() {
            if (!firestoreInitialized) { setTemporaryMessage(addMessage, 'فشل الاتصال بقاعدة البيانات.', 'message-error', false); return; }
            const text = bulkInput.value.trim();
            if (!text) { setTemporaryMessage(addMessage, "الرجاء إدخال النص أولاً.", "message-warning", false); return; } // Changed class to warning

            toggleButtonLoading(addBulkBtn, addBtnText, addBtnLoader, true, 'جار الإضافة...'); // More specific loading text
            setTemporaryMessage(addMessage, 'جاري إضافة الكلمات...', 'message-info', false); // Initial message

            const lines = text.split('\n');
            let addedCount = 0; let skippedCount = 0; let errorCount = 0;
            const wordsToAdd = [];

            lines.forEach(line => {
                line = line.trim(); if (!line) return;
                // Regex allows more flexible separators (:, =, tab) with optional spaces
                const parts = line.split(/\s*[:=\t]\s*/, 2);
                if (parts.length === 2) {
                    const word = parts[0].trim(); const translation = parts[1].trim();
                    if (word && translation) {
                        wordsToAdd.push({ word: word, translation: translation }); // Status added in addWordFirestore
                    } else { skippedCount++; }
                } else { skippedCount++; }
            });

            // Use Promise.all for potentially faster checking/adding if order doesn't matter
            const addPromises = wordsToAdd.map(async (wordObj) => {
                 try {
                     const exists = await checkWordExists(wordObj.word);
                     if (!exists) {
                         await addWordFirestore(wordObj);
                         addedCount++;
                     } else {
                         skippedCount++;
                     }
                 } catch (error) {
                     errorCount++;
                 }
             });

            await Promise.all(addPromises); // Wait for all additions/checks to complete

            // Construct final message
            let messageText = ''; let messageClass = 'message-default';
            if (addedCount > 0) { messageText += `تمت إضافة ${addedCount} كلمة جديدة. `; messageClass = 'message-success'; }
            if (skippedCount > 0) { messageText += `تم تخطي ${skippedCount} سطراً (مكرر أو تنسيق خطأ). `; if (addedCount === 0 && errorCount === 0) messageClass = 'message-warning'; }
            if (errorCount > 0) { messageText += `فشل إضافة ${errorCount} كلمة بسبب خطأ. `; messageClass = 'message-error'; }

            if (!messageText && lines.filter(l=>l.trim()).length > 0) { messageText = "لم تتم إضافة أي كلمات جديدة (قد تكون مكررة أو بتنسيق خطأ)."; messageClass = 'message-info'; }
            else if (lines.filter(l=>l.trim()).length === 0) { messageText = "لم يتم إدخال أي نص."; messageClass = 'message-warning'; } // Should be caught earlier, but good fallback

            setTemporaryMessage(addMessage, messageText.trim(), messageClass, false);
            if(addedCount > 0) bulkInput.value = ''; // Clear input only if something was added

            toggleButtonLoading(addBulkBtn, addBtnText, addBtnLoader, false);
        }

        // handleDeleteAll function remains but is unused by UI
        /*
        async function handleDeleteAll() {
             if (!firestoreInitialized) { setTemporaryMessage(deleteMessage, 'فشل الاتصال بقاعدة البيانات.', 'message-error', false); return; }
             if (!confirm('هل أنت متأكد أنك تريد حذف جميع الكلمات؟ لا يمكن التراجع عن هذا الإجراء.')) { return; }
             // Use the correct elements if re-enabled
             // toggleButtonLoading(deleteAllBtn, deleteBtnText, deleteBtnLoader, true, '');
             // setTemporaryMessage(deleteMessage, 'جاري حذف جميع الكلمات...', 'message-info', false);
             try {
                 const deletedCount = await deleteAllWordsFirestore();
                 // setTemporaryMessage(deleteMessage, `تم حذف ${deletedCount} كلمة بنجاح.`, 'message-success', false);
             } catch (error) {
                 // setTemporaryMessage(deleteMessage, 'حدث خطأ أثناء حذف الكلمات.', 'message-error', false);
             } finally {
                 // toggleButtonLoading(deleteAllBtn, deleteBtnText, deleteBtnLoader, false);
             }
        }
        */

        async function startSession() {
             if (!firestoreInitialized) { setSessionMessage('فشل الاتصال بقاعدة البيانات.', 'message-error'); return; }
            hardWordsListContainer.classList.add('hidden'); copyMessage.textContent = '';
            toggleButtonLoading(startSessionBtn, startBtnText, startBtnLoader, true, 'جار التحميل...');
            setSessionMessage('جاري تحميل الكلمات الصعبة...', 'message-info');
            flashcardContainer.classList.add('hidden'); // Hide card until words are loaded

            try {
                currentSessionWords = await getHardWordsFirestore();
                if (currentSessionWords.length === 0) {
                    setSessionMessage('لا توجد كلمات صعبة للمراجعة حالياً. أضف المزيد!', 'message-success'); // Changed message
                    flashcardContainer.classList.add('hidden');
                    startSessionBtn.classList.remove('hidden'); // Show start button again
                    toggleButtonLoading(startSessionBtn, startBtnText, startBtnLoader, false); // Ensure button is re-enabled
                    return;
                }
                // Shuffle the words (Fisher-Yates shuffle)
                for (let i = currentSessionWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentSessionWords[i], currentSessionWords[j]] = [currentSessionWords[j], currentSessionWords[i]];
                }
                currentWordIndex = 0;
                setSessionMessage('', 'message-info'); // Clear loading message
                flashcardContainer.classList.remove('hidden');
                startSessionBtn.classList.add('hidden'); // Hide start button during session
                displayCurrentWord();
            } catch (error) {
                console.error("Error starting session:", error);
                setSessionMessage('حدث خطأ أثناء بدء الجلسة.', 'message-error');
                startSessionBtn.classList.remove('hidden'); // Show start button on error
            } finally {
                 // Loading state handled inside the try/catch based on outcome
                 if (currentSessionWords.length > 0 || !firestoreInitialized) {
                     // Keep loader hidden if session started or if DB error stopped it
                 } else {
                     toggleButtonLoading(startSessionBtn, startBtnText, startBtnLoader, false);
                 }
            }
        }

        async function endSession() {
             flashcardContainer.classList.add('hidden');
             startSessionBtn.classList.remove('hidden'); // Show start button again
             setSessionMessage('رائع! اكتملت الجلسة.', 'message-success');

             if (!firestoreInitialized) {
                 setSessionMessage('اكتملت الجلسة (لا يمكن عرض القائمة المتبقية - خطأ اتصال).', 'message-warning');
                 return;
             }

             try {
                 // Re-fetch hard words to show the *actual* remaining ones
                 const remainingHardWords = await getHardWordsFirestore();
                 if (remainingHardWords.length > 0) {
                     const formattedList = remainingHardWords.map(item => `${item.word} : ${item.translation}`).join('\n');
                     hardWordsOutput.value = formattedList;
                     hardWordsListContainer.classList.remove('hidden');
                     setSessionMessage(`اكتملت الجلسة. الكلمات المتبقية (${remainingHardWords.length}):`, 'message-info'); // More informative
                 } else {
                     hardWordsOutput.value = '';
                     hardWordsListContainer.classList.add('hidden');
                     setSessionMessage('رائع! لقد أتقنت كل الكلمات الصعبة.', 'message-success');
                 }
             } catch (error) {
                 console.error("Error fetching remaining hard words:", error);
                 hardWordsListContainer.classList.add('hidden');
                 setSessionMessage('اكتملت الجلسة (خطأ في عرض الكلمات المتبقية).', 'message-warning');
             }
        }

        function displayCurrentWord() {
             if (currentWordIndex >= currentSessionWords.length) { endSession(); return; }

             const currentWord = currentSessionWords[currentWordIndex];
             wordDisplay.textContent = currentWord.word;
             translationDisplay.textContent = currentWord.translation;
             progressDisplay.textContent = `الكلمة ${currentWordIndex + 1} / ${currentSessionWords.length}`;wordDisplay

             // Reset state for new card
             translationDisplay.classList.add('hidden');
             difficultyButtonsContainer.classList.remove('hidden');
             showTranslationBtn.classList.remove('hidden');
             markEasyBtn.disabled = false; // Enable 'Hard' button
             markHardBtn.disabled = false; // Enable 'Easy' button
         }

        function handleShowTranslation() {
            translationDisplay.classList.toggle('hidden');
        }

        // NOTE: Button IDs/Text might be confusing vs. status
        // markEasyBtn (Red X) => Keep status 'hard' (User found it difficult)
        // markHardBtn (Green Check) => Set status 'easy' (User found it easy)

        async function markWordAsEasy() { // Renamed for clarity (Called by Green Check / markHardBtn)
             if (!firestoreInitialized) { setSessionMessage('خطأ اتصال، لا يمكن تحديث الحالة.', 'message-error'); return; }
             if (currentWordIndex >= currentSessionWords.length) return; // Already finished

             markEasyBtn.disabled = true; // Disable both buttons
             markHardBtn.disabled = true;

             const currentWordObject = currentSessionWords[currentWordIndex];
             try {
                 await updateWordStatusFirestore(currentWordObject.id, 'easy');
                 goToNextWord();
             } catch(error) {
                 console.error("Error marking word as easy:", error);
                 setSessionMessage("خطأ في تحديث حالة الكلمة.", "message-error");
                 markEasyBtn.disabled = false; // Re-enable buttons on error
                 markHardBtn.disabled = false;
             }
        }

        function markWordAsHard() { // Renamed for clarity (Called by Red X / markEasyBtn)
             // No DB update needed, just go to next word. Status remains 'hard'.
             if (currentWordIndex >= currentSessionWords.length) return; // Already finished
             markEasyBtn.disabled = true;
             markHardBtn.disabled = true;
             goToNextWord();
        }

        function goToNextWord() {
             currentWordIndex++;
             // Fade out effect
             flashcardContent.style.opacity = '0';
             setTimeout(() => {
                 displayCurrentWord();
                 // Fade in effect
                 flashcardContent.style.transition = 'opacity 0.15s ease-in-out';
                 flashcardContent.style.opacity = '1';
             }, 150); // Match CSS transition duration
        }

        async function handleCopyHardWords() {
            copyMessage.textContent = '';
            const textToCopy = hardWordsOutput.value;
            if (!textToCopy) { setTemporaryMessage(copyMessage, 'لا توجد كلمات لنسخها.', 'message-warning', true); return; }

            if (!navigator.clipboard || !navigator.clipboard.writeText) {
                setTemporaryMessage(copyMessage, 'المتصفح لا يدعم النسخ أو تحتاج لـ HTTPS.', 'message-warning', true);
                // Fallback: select text for manual copy
                hardWordsOutput.select();
                hardWordsOutput.setSelectionRange(0, 99999); // For mobile devices
                return;
             }

            try {
                await navigator.clipboard.writeText(textToCopy);
                setTemporaryMessage(copyMessage, 'تم النسخ بنجاح!', 'message-success', true);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                setTemporaryMessage(copyMessage, 'فشل النسخ.', 'message-error', true);
                 // Fallback: select text for manual copy
                hardWordsOutput.select();
                hardWordsOutput.setSelectionRange(0, 99999);
            }
         }

        function setTemporaryMessage(element, message, cssClassSuffix, isSmall = false) {
            if (!element) return; // Safety check
            element.textContent = message;
            // Remove existing message classes before adding new one
            element.classList.remove('message-success', 'message-error', 'message-info', 'message-warning', 'message-default');
            element.classList.add(`message-${cssClassSuffix}`);
            // Simplified class setting
            element.className = element.className.replace(/text-xs mt-1 h-3|text-xs mt-2 h-4/g, '').trim(); // Remove old size/margin/height
            const sizeMarginHeightClass = isSmall ? 'text-xs mt-1 h-3' : 'text-xs mt-2 h-4';
            element.classList.add(...sizeMarginHeightClass.split(' ')); // Add new size/margin/height

            const duration = message.length > 30 ? 4000 : 3000; // Keep dynamic duration
            setTimeout(() => {
                if (element.textContent === message) { // Only clear if the message hasn't changed
                    element.textContent = '';
                    element.classList.remove(`message-${cssClassSuffix}`);
                    element.classList.add('message-default'); // Reset to default class
                }
            }, duration);
        }

        function setSessionMessage(message, cssClassSuffix) {
             if (!sessionMessage) return;
             sessionMessage.textContent = message;
             // Remove existing message classes before adding new one
             sessionMessage.classList.remove('message-success', 'message-error', 'message-info', 'message-warning', 'message-default');
             sessionMessage.classList.add(`message-${cssClassSuffix}`);
             // Ensure base classes are present
             sessionMessage.className = `message ${cssClassSuffix ? `message-${cssClassSuffix}` : 'message-default'} message--info h-5 text-xs font-semibold mt-4 text-center`; // Added text-center
         }

        // Event Listeners
        gotoAddBtn_FromReview.addEventListener('click', () => showPage('pageAddWords'));

        // MODIFIED: Go to Review AND Start Session
        gotoReviewBtn_FromAdd.addEventListener('click', () => {
            showPage('pageReview');
            startSession(); // Immediately attempt to start the session
        });

        pasteBtn.addEventListener('click', handlePaste);
        addBulkBtn.addEventListener('click', addWordsFromText);
        // deleteAllBtn listener removed as button is removed
        // deleteAllBtn.addEventListener('click', handleDeleteAll);
        startSessionBtn.addEventListener('click', startSession);
        showTranslationBtn.addEventListener('click', handleShowTranslation);

        // Connect correct buttons to correct actions based on revised understanding
        markEasyBtn.addEventListener('click', markWordAsHard);   // Red X = I found it Hard
        markHardBtn.addEventListener('click', markWordAsEasy); // Green Check = I found it Easy

        copyHardWordsBtn.addEventListener('click', handleCopyHardWords);

        // Initial Setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
             const allButtons = document.querySelectorAll('button');
             allButtons.forEach(btn => btn.disabled = true); // Disable all initially

             if (firestoreInitialized) {
                 setSessionMessage('قاعدة البيانات جاهزة.', 'message-info');
                 allButtons.forEach(btn => btn.disabled = false); // Enable all if DB ready
                 showPage('pageAddWords'); // Default to Add page
             } else {
                  setSessionMessage('فشل تهيئة قاعدة البيانات! لا يمكن حفظ أو تحميل الكلمات.', 'message-error');
                  // Only enable navigation/paste buttons if DB fails, disable functions requiring DB
                  const nonDbButtons = [gotoAddBtn_FromReview, gotoReviewBtn_FromAdd, pasteBtn];
                  nonDbButtons.forEach(btn => { if(btn) btn.disabled = false; });
                  showPage('pageAddWords'); // Default to Add page, but core functions won't work
             }
        });

    </script>
</body>
</html>
